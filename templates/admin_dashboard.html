<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админ — панель</title>
  <style>
    :root {
      --bg-start: #efe4ff;
      --bg-end: #d9c2ff;
      --card: rgba(255, 255, 255, 0.95);
      --border: #b388ff;
      --muted: #4a3b63;
      --text: #2c1f3a;
      --primary: #7b33c8;
      --primary-hover: #652aa4;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      max-width: 1040px;
      margin: 0 auto;
      padding: 28px;
      background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
      color: var(--text);
    }
    h1 {
      margin-bottom: 8px;
      letter-spacing: -0.01em;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 10px;
      letter-spacing: -0.01em;
    }
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px 18px 20px;
      margin-bottom: 16px;
      box-shadow: 0 14px 36px rgba(82, 0, 109, 0.15);
      border: 2px solid var(--border);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #111827;
    }
    input[type="text"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 2px solid var(--border);
      box-sizing: border-box;
      margin-top: 6px;
      background: rgba(255, 255, 255, 0.9);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      font-size: 14px;
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(123, 51, 200, 0.25);
      background: #fff;
    }
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease;
      box-shadow: 0 12px 30px rgba(101, 42, 164, 0.25);
    }
    button.secondary {
      background: linear-gradient(135deg, #9a88c7, #7b33c8);
      border: 1px solid rgba(154, 136, 199, 0.5);
      box-shadow: 0 10px 26px rgba(122, 102, 176, 0.2);
    }
    button.danger {
      background: #dc2626;
      box-shadow: none;
    }
    button.small {
      padding: 6px 10px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }
    button:hover:not(:disabled) { filter: brightness(1.03); transform: translateY(-1px); }
    button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 8px 22px rgba(37, 99, 235, 0.22); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: inset 0 1px 0 rgba(123, 51, 200, 0.08);
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 12px;
    }
    .table-wrapper table { min-width: 720px; }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      vertical-align: top;
    }
    th {
      text-align: left;
      background: rgba(123, 51, 200, 0.08);
      color: #2c1f3a;
      font-weight: 700;
    }
    tbody tr:hover { background: #f9fafb; }
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    .status {
      font-size: 13px;
      margin-top: 4px;
      color: var(--muted);
    }
    .tag {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(123, 51, 200, 0.1);
      font-size: 11px;
      margin-right: 6px;
      color: #4a2c7b;
      font-weight: 600;
    }
    .row-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .logo-preview {
      max-height: 36px;
    }
    .qr-preview {
      max-height: 56px;
      cursor: zoom-in;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(82, 0, 109, 0.15);
    }
    .flex {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .modal-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }
    .modal-card {
      background: #fff;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.18);
      max-width: 440px;
      width: calc(100% - 24px);
      text-align: center;
    }
    .modal-card img {
      max-width: 100%;
      height: auto;
    }
    .modal-card h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }

    @media (max-width: 900px) {
      body { padding: 20px; }
      h1 { font-size: 24px; }
      h2 { font-size: 18px; }
      .card { padding: 16px; }
      .flex { flex-direction: column; align-items: flex-start; }
      .row-actions { flex-direction: column; align-items: stretch; }
      .row-actions button { width: 100%; }
      .row-actions input { width: 100%; }
      .table-wrapper { margin: 0 -6px; padding: 0 6px; }
      table { min-width: 640px; }
    }
  </style>
</head>
<body>
  <h1>Админ-панель Voice Feedback</h1>
  <p class="muted">
    Здесь можно создавать компании, получать ссылки/QR-коды и работать с отзывами.
  </p>

  <div class="card">
    <h2>Промпт для нейросети</h2>
    <p class="muted" style="margin-top: -4px;">
      Используется по умолчанию для всех компаний.
    </p>
    <textarea id="normalizationPrompt" rows="9">{{ normalization_prompt }}</textarea>
    <div class="flex" style="margin-top: 10px;">
      <button id="savePrompt" type="button">Сохранить</button>
      <span id="promptStatus" class="status"></span>
    </div>
  </div>

  <!-- Блок создания компании -->
  <div class="card">
    <h2>Создать компанию</h2>
    <form id="createCompanyForm">
      <label>
        Название компании
        <input type="text" id="companyName" required />
      </label>
      <label>
        Slug (для URL, латиница, без пробелов, например <code>beauty-salon-lux</code>)
        <input type="text" id="companySlug" required />
      </label>
      <label>
        Email (куда отправлять отзывы)
        <input type="email" id="companyEmail" required />
      </label>
      <button type="submit">Создать компанию</button>
      <span id="createStatus" class="status"></span>
    </form>
  </div>

  <!-- Список компаний -->
  <div class="card">
    <div class="flex">
      <h2 style="margin-bottom: 0;">Компании</h2>
      <button id="refreshCompanies" type="button" class="secondary small">Обновить список</button>
    </div>
    <div id="companiesContainer" class="muted" style="margin-top: 8px;">Загрузка...</div>
  </div>

  <!-- Отчёты -->
  <div class="card">
    <h2>Отзывы</h2>
    <p class="muted">
      CSV-файл можно открыть в Excel/Google Sheets.
    </p>
    <button id="downloadAllCsv" type="button" class="secondary small">
      Скачать все отзывы (CSV)
    </button>
    <span class="muted" style="margin-left: 8px;">или скачай по компании из таблицы.</span>
  </div>

  <div id="qrModal" class="modal-backdrop">
    <div class="modal-card">
      <h3>QR-код</h3>
      <img id="qrModalImg" src="" alt="QR код">
      <div style="margin-top: 12px;">
        <button id="closeQrModal" class="secondary small" type="button">Закрыть</button>
      </div>
    </div>
  </div>
  
  <script>
    // Важно: сервис висит под /voice-feedback/, поэтому префикс:
    const BASE = '/voice-feedback';

    const createForm = document.getElementById('createCompanyForm');
    const nameInput = document.getElementById('companyName');
    const slugInput = document.getElementById('companySlug');
    const emailInput = document.getElementById('companyEmail');
    const createStatus = document.getElementById('createStatus');

    const promptTextarea = document.getElementById('normalizationPrompt');
    const savePromptBtn = document.getElementById('savePrompt');
    const promptStatus = document.getElementById('promptStatus');

    const companiesContainer = document.getElementById('companiesContainer');
    const refreshBtn = document.getElementById('refreshCompanies');
    const downloadAllCsvBtn = document.getElementById('downloadAllCsv');

    let companies = [];

    async function loadCompanies() {
      companiesContainer.textContent = 'Загрузка...';
      try {
        const res = await fetch(`${BASE}/api/admin/companies`);
        if (!res.ok) throw new Error('Ошибка загрузки компаний');
        companies = await res.json();
        renderCompanies();
      } catch (e) {
        companiesContainer.textContent = 'Не удалось загрузить список компаний.';
        console.error(e);
      }
    }

    function renderCompanies() {
      if (!companies.length) {
        companiesContainer.textContent = 'Компаний пока нет.';
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>ID</th>
          <th>Компания</th>
          <th>Пути / ссылки</th>
          <th>Логотип / QR</th>
          <th>Действия</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      companies.forEach((c) => {
        const tr = document.createElement('tr');

        const tdId = document.createElement('td');
        tdId.textContent = c.id;
        tr.appendChild(tdId);

        const tdName = document.createElement('td');
        tdName.innerHTML = `
          <strong>${c.name}</strong><br>
          <span class="muted">Slug: ${c.slug}</span><br>
          <span class="muted">Email: ${c.email}</span>
        `;
        tr.appendChild(tdName);

        const publicUrl = `${window.location.origin}${BASE}/r/${c.slug}`;
        const qrUrl = c.qr_path ? `${BASE}${c.qr_path}` : null;
        const logoUrl = c.logo_path ? `${BASE}${c.logo_path}` : null;

        const tdLinks = document.createElement('td');
        tdLinks.innerHTML = `
          <span class="tag">Публичная страница</span><br>
          <a href="${publicUrl}" target="_blank">${publicUrl}</a>
        `;
        tr.appendChild(tdLinks);

        const tdMedia = document.createElement('td');
        tdMedia.innerHTML = `
          ${logoUrl ? `<div><span class="muted">Логотип:</span><br><img class="logo-preview" src="${logoUrl}" alt="logo"></div>`
 : '<div class="muted">Логотип: нет</div>'}
          ${qrUrl ? `<div style="margin-top:4px;"><span class="muted">QR:</span><br><img class="qr-preview" data-qr="${qrUrl}" src="${qrUrl}" alt="qr"></div>` : '<div class="muted">QR будет сгенерирован автоматически</div>'}
        `;
        tr.appendChild(tdMedia);

        const tdActions = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'row-actions';

        // Загрузка логотипа
        const logoInputId = `logo-input-${c.id}`;
        const logoBlock = document.createElement('div');
        logoBlock.innerHTML = `
          <input type="file" id="${logoInputId}" accept="image/*" style="max-width:160px; font-size:12px; margin-bottom:4px;">
          <button class="small secondary" type="button">Загрузить</button>
        `;
        const uploadBtn = logoBlock.querySelector('button');
        uploadBtn.onclick = () => uploadLogo(c.id, logoInputId);

        // CSV по компании
        const csvBtn = document.createElement('button');
        csvBtn.type = 'button';
        csvBtn.className = 'small secondary';
        csvBtn.textContent = 'CSV по компании';
        csvBtn.onclick = () => downloadCsvForCompany(c.id);

        // Отзывы
        const reviewsBtn = document.createElement('button');
        reviewsBtn.type = 'button';
        reviewsBtn.className = 'small';
        reviewsBtn.textContent = 'Отзывы';
        reviewsBtn.onclick = () => openReviewsPage(c.id);

        // Удаление
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'small danger';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.onclick = () => deleteCompany(c.id, c.name);

        actions.appendChild(logoBlock);
        actions.appendChild(csvBtn);
        actions.appendChild(reviewsBtn);
        actions.appendChild(deleteBtn);
        tdActions.appendChild(actions);

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      wrapper.appendChild(table);

      companiesContainer.innerHTML = '';
      companiesContainer.appendChild(wrapper);

      document.querySelectorAll('[data-qr]').forEach((img) => {
        img.addEventListener('click', () => openQrModal(img.dataset.qr));
      });
    }

    function openQrModal(qrUrl) {
      const modal = document.getElementById('qrModal');
      const img = document.getElementById('qrModalImg');
      img.src = qrUrl;
      modal.classList.add('active');
    }

    function closeQrModal() {
      const modal = document.getElementById('qrModal');
      const img = document.getElementById('qrModalImg');
      img.src = '';
      modal.classList.remove('active');
    }

    async function uploadLogo(companyId, inputId) {
      const input = document.getElementById(inputId);
      if (!input.files.length) {
        alert('Выберите файл логотипа');
        return;
      }
      const file = input.files[0];
      const fd = new FormData();
      fd.append('file', file);

      try {
        const res = await fetch(`${BASE}/api/admin/companies/${companyId}/logo`, {
          method: 'POST',
          body: fd,
        });
        if (!res.ok) throw new Error('Ошибка загрузки логотипа');
        await res.json();
        await loadCompanies();
      } catch (e) {
        alert('Не удалось загрузить логотип');
        console.error(e);
      }
    }

    async function deleteCompany(companyId, companyName) {
      if (!confirm(`Удалить компанию "${companyName}" со всеми отзывами?`)) return;
      try {
        const res = await fetch(`${BASE}/api/admin/companies/${companyId}`, {
          method: 'DELETE',
        });
        if (!res.ok) throw new Error('Ошибка удаления');
        await loadCompanies();
      } catch (e) {
        alert('Не удалось удалить компанию');
        console.error(e);
      }
    }

    function downloadCsvForCompany(companyId) {
      const url = `${BASE}/api/admin/reviews/export?company_id=${companyId}`;
      window.open(url, '_blank');
    }

    function openReviewsPage(companyId) {
      window.location.href = `${BASE}/admin/companies/${companyId}/reviews`;
    }
    
    // Создание компании
    createForm.onsubmit = async (e) => {
      e.preventDefault();
      createStatus.textContent = '';
      const payload = {
        name: nameInput.value.trim(),
        slug: slugInput.value.trim(),
        email: emailInput.value.trim(),
      };
      if (!payload.name || !payload.slug || !payload.email) {
        createStatus.textContent = 'Заполните все поля.';
        return;
      }
      try {
        const res = await fetch(`${BASE}/api/admin/companies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data.detail || 'Ошибка создания компании';
          createStatus.textContent = msg;
          return;
        }
        await res.json();
        createStatus.textContent = 'Компания создана.';
        nameInput.value = '';
        slugInput.value = '';
        emailInput.value = '';
        await loadCompanies();
      } catch (e) {
        console.error(e);
        createStatus.textContent = 'Ошибка сети при создании компании.';
      }
    };

    refreshBtn.onclick = () => loadCompanies();

    downloadAllCsvBtn.onclick = () => {
      const url = `${BASE}/api/admin/reviews/export`;
      window.open(url, '_blank');
    };

    document.getElementById('closeQrModal').onclick = closeQrModal;
    document.getElementById('qrModal').addEventListener('click', (e) => {
      if (e.target.id === 'qrModal') {
        closeQrModal();
      }
    });

    savePromptBtn.onclick = async () => {
      promptStatus.textContent = '';
      savePromptBtn.disabled = true;
      try {
        const res = await fetch(`${BASE}/api/admin/prompt`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: promptTextarea.value })
        });
        if (!res.ok) throw new Error('Ошибка сохранения промпта');
        const data = await res.json();
        promptTextarea.value = data.prompt || '';
        promptStatus.textContent = 'Сохранено';
      } catch (e) {
        console.error(e);
        promptStatus.textContent = 'Не удалось сохранить промпт';
      } finally {
        savePromptBtn.disabled = false;
      }
    };

    // начальная загрузка
    loadCompanies();
  </script>
</body>
</html>
