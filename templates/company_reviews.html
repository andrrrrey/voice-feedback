<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Отзывы — {{ company.name }}</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
      background: #f5f5f7;
      color: #0f172a;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1 { margin-bottom: 6px; }
    .muted { color: #6b7280; font-size: 14px; }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-top: 16px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    th { text-align: left; background: #f9fafb; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #e5e7eb; font-size: 12px; }
    .tag.positive { background: #d1fae5; color: #065f46; }
    .tag.negative { background: #fee2e2; color: #991b1b; }
    .tag.neutral { background: #e5e7eb; color: #374151; }
    .table-note { margin-top: 8px; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; background: #2563eb; color: #fff; }
    button.secondary { background: #6b7280; }
  </style>
</head>
<body>
  <div class="actions">
    <a href="{{ request.url_for('admin_login_page') }}" class="secondary">⟵ К админке</a>
    <a href="{{ '/voice-feedback/admin' }}" style="display:none"></a>
  </div>
  <h1>Отзывы — {{ company.name }}</h1>
  <p class="muted">Собранные отзывы по компании. CSV можно скачать из основной панели.</p>

  <div class="card">
    <div class="actions">
      <span class="muted">Slug: {{ company.slug }}</span>
      <button id="refreshBtn" class="secondary" type="button">Обновить</button>
      <button id="backBtn" class="secondary" type="button">Назад</button>
    </div>
    <div id="reviewsContainer" class="muted" style="margin-top: 10px;">Загрузка...</div>
  </div>

  <script>
    const BASE = '/voice-feedback';
    const companyId = {{ company.id }};
    const backBtn = document.getElementById('backBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const container = document.getElementById('reviewsContainer');

    async function loadReviews() {
      container.textContent = 'Загрузка...';
      try {
        const res = await fetch(`${BASE}/api/admin/reviews?company_id=${companyId}`);
        if (!res.ok) throw new Error('Ошибка загрузки');
        const data = await res.json();
        renderReviews(data);
      } catch (e) {
        console.error(e);
        container.textContent = 'Не удалось загрузить отзывы.';
      }
    }

    function renderReviews(reviews) {
      if (!reviews.length) {
        container.textContent = 'Пока нет отзывов для этой компании.';
        return;
      }
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Статус</th>
            <th>Тональность</th>
            <th>Текст</th>
            <th>Создан</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');
      reviews.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.user_name || '—'}</td>
          <td>${r.status}</td>
          <td>${sentimentTag(r.sentiment)}</td>
          <td>${(r.normalized_text || '').replace(/</g, '&lt;')}</td>
          <td>${new Date(r.created_at).toLocaleString('ru-RU')}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
      const note = document.createElement('div');
      note.className = 'muted table-note';
      note.textContent = 'Для выгрузки CSV вернитесь и нажмите «CSV по компании» или общий экспорт.';
      container.appendChild(note);
    }

    function sentimentTag(sentiment) {
      const val = (sentiment || '').toLowerCase();
      let cls = 'neutral';
      if (val.includes('pos')) cls = 'positive';
      if (val.includes('neg')) cls = 'negative';
      return `<span class="tag ${cls}">${sentiment || 'n/a'}</span>`;
    }

    refreshBtn.onclick = loadReviews;
    backBtn.onclick = () => {
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = `${BASE}/admin/login`;
      }
    };

    loadReviews();
  </script>
</body>
</html>