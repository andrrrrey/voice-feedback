<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Отзывы — {{ company.name }}</title>
  <style>
    :root {
      --bg-start: #efe4ff;
      --bg-end: #d9c2ff;
      --card: rgba(255, 255, 255, 0.95);
      --border: #b388ff;
      --muted: #4a3b63;
      --text: #2c1f3a;
      --primary: #7b33c8;
      --primary-hover: #652aa4;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
      background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
      color: var(--text);
    }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1 { margin-bottom: 6px; }
    .muted { color: var(--muted); font-size: 14px; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 14px 36px rgba(82, 0, 109, 0.15);
      border: 2px solid var(--border);
      margin-top: 16px;
    }
    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; min-width: 640px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    th { text-align: left; background: rgba(123, 51, 200, 0.08); color: var(--text); }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(123, 51, 200, 0.12); font-size: 12px; color: #4a2c7b; }
    .tag.positive { background: #d1fae5; color: #065f46; }
    .tag.negative { background: #fee2e2; color: #991b1b; }
    .tag.neutral { background: rgba(123, 51, 200, 0.12); color: #4a2c7b; }
    .table-note { margin-top: 8px; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: #fff; box-shadow: 0 12px 30px rgba(101, 42, 164, 0.25); transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease; }
    button.secondary { background: linear-gradient(135deg, #9a88c7, #7b33c8); box-shadow: 0 10px 26px rgba(122, 102, 176, 0.2); }
    button:hover { filter: brightness(1.03); transform: translateY(-1px); }
    button:active { transform: translateY(0); box-shadow: 0 10px 22px rgba(101, 42, 164, 0.25); }

    @media (max-width: 720px) {
      body { padding: 16px; }
      h1 { font-size: 22px; }
      .card { padding: 14px; }
      .actions { flex-direction: column; align-items: stretch; }
      button { width: 100%; text-align: center; }
      .table-wrapper { margin: 0 -6px; padding: 0 6px; }
    }
  </style>
</head>
<body>
  <h1>Отзывы — {{ company.name }}</h1>
  <p class="muted">Собранные отзывы по компании. CSV можно скачать из основной панели.</p>

  <div class="card">
    <div class="actions">
      <span class="muted">Slug: {{ company.slug }}</span>
      <button id="refreshBtn" class="secondary" type="button">Обновить</button>
      <button id="backBtn" class="secondary" type="button">Назад</button>
    </div>
    <div id="reviewsContainer" class="muted" style="margin-top: 10px;">Загрузка...</div>
  </div>

  <script>
    const BASE = '/voice-feedback';
    const companyId = {{ company.id }};
    const backBtn = document.getElementById('backBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const container = document.getElementById('reviewsContainer');

    async function loadReviews() {
      container.textContent = 'Загрузка...';
      try {
        const res = await fetch(`${BASE}/api/admin/reviews?company_id=${companyId}`);
        if (!res.ok) throw new Error('Ошибка загрузки');
        const data = await res.json();
        renderReviews(data);
      } catch (e) {
        console.error(e);
        container.textContent = 'Не удалось загрузить отзывы.';
      }
    }

    function renderReviews(reviews) {
      if (!reviews.length) {
        container.textContent = 'Пока нет отзывов для этой компании.';
        return;
      }
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Тональность</th>
            <th>Текст</th>
            <th>Создан</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');
      reviews.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.user_name || '—'}</td>
          <td>${sentimentTag(r.sentiment)}</td>
          <td>${(r.normalized_text || '').replace(/</g, '&lt;')}</td>
          <td>${new Date(r.created_at).toLocaleString('ru-RU')}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      wrapper.appendChild(table);

      container.innerHTML = '';
      container.appendChild(wrapper);
      const note = document.createElement('div');
      note.className = 'muted table-note';
      note.textContent = 'Для выгрузки CSV вернитесь и нажмите «CSV по компании» или общий экспорт.';
      container.appendChild(note);
    }

    function sentimentTag(sentiment) {
      const val = (sentiment || '').toLowerCase();
      let cls = 'neutral';
      if (val.includes('pos')) cls = 'positive';
      if (val.includes('neg')) cls = 'negative';
      return `<span class="tag ${cls}">${sentiment || 'n/a'}</span>`;
    }

    refreshBtn.onclick = loadReviews;
    backBtn.onclick = () => {
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = `${BASE}/admin/login`;
      }
    };

    loadReviews();
  </script>
</body>
</html>